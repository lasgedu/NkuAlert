name: CD - Deploy to Production

on:
  push:
    branches:
      - main  # Only runs after merge to main

permissions:
  contents: read
  id-token: write
  security-events: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # Checkout code
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------
      # Python Setup
      # ---------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---------------------------------
      # CI Checks (Lint & Tests)
      # ---------------------------------
      - name: Lint with flake8
        run: flake8 .

      - name: Run tests
        run: pytest

      # ---------------------------------
      # Login to Azure Container Registry
      # ---------------------------------
      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: nkualertacr8204.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ---------------------------------
      # Pull latest Docker image
      # ---------------------------------
      - name: Pull latest Docker image
        run: docker pull nkualertacr8204.azurecr.io/nkualert:latest

      # ---------------------------------
      # Install Ansible
      # ---------------------------------
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible sshpass

      # ---------------------------------
      # Run Ansible Playbook on VM
      # ---------------------------------
      - name: Run Ansible Deployment
        run: |
          set -e  # Exit on error
          
          # Save SSH key to temporary file (preserve newlines correctly)
          echo "${{ secrets.APP_SSH_KEY }}" > /tmp/app_key.pem
          chmod 600 /tmp/app_key.pem
          
          # Verify key file was created correctly
          if [ ! -s /tmp/app_key.pem ]; then
            echo "ERROR: SSH key file is empty or missing"
            exit 1
          fi
          
          # Save bastion SSH key (same key for both VMs)
          cp /tmp/app_key.pem /tmp/bastion_key.pem
          chmod 600 /tmp/bastion_key.pem

          # Verify required secrets are set
          if [ -z "${{ secrets.APP_PRIVATE_IP }}" ] || [ -z "${{ secrets.BASTION_PUBLIC_IP }}" ] || [ -z "${{ secrets.APP_USER }}" ]; then
            echo "ERROR: Missing required secrets (APP_PRIVATE_IP, BASTION_PUBLIC_IP, or APP_USER)"
            exit 1
          fi

          # Test SSH connection to bastion first
          echo "Testing bastion connection..."
          ssh -i /tmp/bastion_key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            ${{ secrets.APP_USER }}@${{ secrets.BASTION_PUBLIC_IP }} \
            "echo 'Bastion connection successful'" || {
            echo "ERROR: Failed to connect to bastion host"
            exit 1
          }

          # Create dynamic inventory file for CI/CD
          cat > /tmp/inventory.ini << 'INVENTORY_EOF'
          [app_server]
          app-vm ansible_host=APP_PRIVATE_IP_PLACEHOLDER

          [app_server:vars]
          ansible_user=APP_USER_PLACEHOLDER
          ansible_ssh_private_key_file=/tmp/app_key.pem
          ansible_ssh_common_args='-o ProxyCommand="ssh -i /tmp/bastion_key.pem -W %h:%p -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 APP_USER_PLACEHOLDER@BASTION_IP_PLACEHOLDER" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10'
          INVENTORY_EOF
          
          # Replace placeholders with actual values
          sed -i "s/APP_PRIVATE_IP_PLACEHOLDER/${{ secrets.APP_PRIVATE_IP }}/g" /tmp/inventory.ini
          sed -i "s/APP_USER_PLACEHOLDER/${{ secrets.APP_USER }}/g" /tmp/inventory.ini
          sed -i "s/BASTION_IP_PLACEHOLDER/${{ secrets.BASTION_PUBLIC_IP }}/g" /tmp/inventory.ini

          # Display inventory for debugging (without sensitive data)
          echo "Inventory file created:"
          cat /tmp/inventory.ini | sed 's/ansible_ssh_private_key_file=.*/ansible_ssh_private_key_file=***/'

          # Execute Ansible playbook
          echo "Running Ansible playbook..."
          ansible-playbook ansible/deploy.yml \
            -i /tmp/inventory.ini \
            --private-key /tmp/app_key.pem \
            --user ${{ secrets.APP_USER }} \
            --extra-vars "new_tag=latest acr_password=${{ secrets.ACR_PASSWORD }}" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_SSH_COMMON_ARGS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"
